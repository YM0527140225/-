<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>התחברות</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7fb; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    #box { background:#fff; padding:30px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.1); text-align:center; width:360px; }
    h2 { margin-bottom:12px; }
    .muted { color:#666; font-size:14px; margin-top:8px; }
    .error { color:#d9534f; font-weight:bold; margin-top:10px; }
    .spinner { margin:20px auto; border:4px solid #eee; border-top:4px solid #1f4aff; border-radius:50%; width:36px; height:36px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .success { font-size:32px; color:green; margin:10px 0; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="box">
    <h2>כניסה עם Google</h2>
    <div id="g_id_onload"
         data-client_id="354707783533-6qbh1t1ag75gu34ouc7n5o8i0bp5ec13.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <div id="msg" class="muted">אנא התחבר/י עם חשבון Google</div>
    <div id="error" class="error"></div>
  </div>

  <script>
    function handleCredentialResponse(resp) {
      const token = resp && resp.credential;
      if (!token) {
        showError("לא הצלחנו לחבר אותך, אנא נסה שוב / התחבר עם חשבון אחר.");
        return;
      }

      // בדיקה מול Google
      fetch("https://oauth2.googleapis.com/tokeninfo?id_token=" + encodeURIComponent(token))
        .then(r => r.json())
        .then(data => {
          if (!data || !data.email) {
            showError("לא הצלחנו לחבר אותך, אנא נסה שוב / התחבר עם חשבון אחר.");
            return;
          }
          showSuccess(data.email, token);
        })
        .catch(() => {
          showError("לא הצלחנו לחבר אותך, אנא נסה שוב / התחבר עם חשבון אחר.");
        });
    }

    function showError(msg) {
      document.getElementById("msg").style.display = "none";
      document.getElementById("error").textContent = msg;
    }

    function showSuccess(email, token) {
      const box = document.getElementById("box");
      box.innerHTML = `
        <div class="success">✓</div>
        <h2>ברוך הבא</h2>
        <div>${email}</div>
        <div class="spinner"></div>
        <div class="muted">אנחנו מעבירים אותך לדף המבוקש…</div>
      `;

      // מציאת return_to
      const urlParams = new URLSearchParams(window.location.search);
      const ret = urlParams.get("return_to");
      if (ret) {
        setTimeout(() => {
          // שלח את הנתונים ל-return_to
          const sep = ret.includes("?") ? "&" : "?";
          window.location.href = ret + sep + "email=" + encodeURIComponent(email) + "&id_token=" + encodeURIComponent(token);
        }, 2000);
      }
    }
  </script>
</body>
</html>
